---
title: "Regional Aggregates Results"
author: "United Nations Office on Drugs and Crime"
output: 
  html_document: 
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
---

```{r Setup, include=FALSE}

#Clears the workspace
rm(list = ls())

#usePackage() - Library a package, and installs the package if absent
usePackage <- function(x) {
    if (!is.element(x, installed.packages()[,1]))
        install.packages(x, dep = TRUE)
    require(x, character.only = TRUE)
}

#Packages
usePackage('readxl')
usePackage('tidyr')
usePackage('knitr')
usePackage('ggplot2')
usePackage('scales')
usePackage('gridExtra')
usePackage('writexl')
usePackage('countrycode')
usePackage('dplyr')
usePackage('imputeTS')
usePackage('pander')

#Options
options(knitr.kable.NA = '')
options(scipen=999)

#Plot theme
ptheme <- theme(
  text = element_text(family = "serif", size = 12),
  panel.grid.major.x = element_blank(),
  panel.grid.major.y = element_line(colour = "light gray"),
  panel.background = element_rect(fill = "white"),
  legend.key = element_rect(colour = "transparent", fill = "white"))

```


```{r Load, include=FALSE}

load ("Data/data")
load ("Data/regions")
load ("Data/subregions")

```

----

# Notes

----

* This file includes current results for estimated regional aggregates of all variables
* See the file "Methodology to produce UNODC homicide data series (data version)" for the latest description of the methodology. This file can be found at the following folder: G:\RAB\DDDU\02_Crime\08_Homicide\Homicide Data\Homicide Update 2018\Methodology
* Each tab corresponds to the result of a different indicator of homicides
* Results for each indicator include 
    + Diagnostics of data availability for that indicator;
    + Results of country-level estimates;
    + Estimate's Coverage;
    + Results of region aggregates;
    + Results of subregion aggregates;
* As this file has been produced using code, it is relatively simple to update as new data becomes available

----

# Total Homicide Count

----

**Objective:**

* Calculate the homicide trend of the world, of each of the worldâ€™s regions, and of each subregion

**Methodological Issue: Missing Data**

* Data for many years within countries is often missing
* The number of countries with available data varies considerably by year
* Using a different sample of countries to calculate aggregate rates would results in highly biased trends  
* Only `r length(unique(data[which(data$Years==max(data$Years)),c("UNODC_Name")]))` countries have a complete series of homicide data for between 1990 and 2016
* Countries with complete series: `r unique(data[which(data$Years==max(data$Years)),c("UNODC_Name")])`
* One solution is to increase the number of countries with complete series by estimating homicide counts for missing years

## Data Availability {.tabset}

### Number of Countries

```{r Number Countries Total, warning = FALSE, echo = FALSE}

#Sample by Region
ggplot(regions[regions$Sample!=0,], aes(y = Sample, x = Year, colour = Region)) +
  ggtitle("Number of Countries with Data by Region & Year") +
  ylab("Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  ptheme

#Table of Countries with Data by Region
wide_regions <- spread(regions[, c("Region","Year","Sample")], key = "Year", value = "Sample")

kable(wide_regions, caption = "Countries with Data Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)

```

### Percent of Countries

```{r Percent Countries Total, warning = FALSE, echo = FALSE}

#Sample countries by region & year
ggplot(regions[regions$Sample!=0,], aes(y = Sample/Countries, x = Year, colour = Region)) +
  ggtitle("Percent of Countries with Data per Region & Year") +
  ylab("Percent of Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  ptheme

#Table of Percent of Countries Estimated by Region
regions$Per_Sample <- paste0(round(regions$Sample/regions$Countries*100,1),"%")

wide_regions <- spread(regions[,c("Region","Year","Per_Sample")], key = "Year", value = "Per_Sample")

kable(wide_regions, caption = "Proportion of Countries with Data per Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)
regions$Per_Sample <- NULL

```

### Percent of Population

```{r Population Sample Total, warning = FALSE, echo = FALSE}

#Sample population by region & year
ggplot(regions[regions$Sample!=0,], aes(y = Pop_Sample/Pop, x = Year, colour = Region)) +
  ggtitle("Percent of Population Living in Countries with Data per Region & Year") +
  ylab("Percent of Population") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  ptheme

#Table of Percent of Population from Estimated Countries by Region & Year
regions$Per_Sample <- paste0(round(regions$Pop_Sample/regions$Pop*100,1),"%")

wide_regions <- spread(regions[,c("Region","Year","Per_Sample")], key = "Year", value = "Per_Sample")

kable(wide_regions, caption = "Proportion of Population Ling in Countries with Data per Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)
regions$Per_Sample <- NULL

```

## Country Estimates {.tabset}

**Estimation Strategy: Moving Average:**

* Missing years of each country are estimated using a Exponentially Weighted Moving average (k=100)
* For each individual country, the homicide **rate** of missing years is replaced by the average homicide **rate** of other years in that countries' series
* The impact of each year on the average is exponentially weighted by the time-difference between that year and the estimate
* The following is a selection of ilustrative countries

```{r Country Estimates Total, warning = FALSE, message = FALSE, echo = FALSE, results= 'asis'}

s <- c("Bahamas","Egypt","Honduras","Indonesia","Myanmar","Republic of Korea","Russian Federation","Saudi Arabia","South Sudan","United Republic of Tanzania")

for (i in s) {
  cat("### ", i, "\n")
  a <- 
    ggplot(subset(data,UNODC_Name==i), aes(x = Year)) +
    geom_line(aes(y = Rate_Est), colour="Red") +
    geom_point(aes(y = Rate_Est), colour="Red", shape=21, fill="white", size=2) +
    geom_line(aes(y = Rate_Total)) +
    geom_point(aes(y = Rate_Total), size=2) +
    ggtitle(paste(i,"-",unique(data$Subregion[data$UNODC_Name==i]))) +
    ylab("Homicide Rate") +
    xlab("Year") +
    ptheme
  
  print(a)
  cat("\n","\n")
}

```

## Estimate's Coverage {.tabset}

### Region Coverage

```{r Region Coverage Total, warning = FALSE, message = FALSE, echo = FALSE, results= 'asis'}

#Table of Countries Covered by Region
kable(regions[regions$Year==2016,c("Region","Countries","Pop","Covered","Pop_Covered","Per_Covered")], 
      caption = "Countries Covered in Estimated Trend",
      col.names = c("Region","Total Countries","Total Population","Countries Covered","Population Covered","Proportion of Population Covered"),
      format.args = list(big.mark = ","),
      digits = 3,
      row.names = FALSE)

```

### Coverage Plot

```{r Coverage Plot Total, warning = FALSE, echo = FALSE}

#Sample by Region
ggplot(regions, aes(y = Covered, x = Year, group = Region)) +
  ggtitle("Number of Countries Covered by Region & Year") +
  ylab("Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  ptheme

```

### Subregion Coverage

```{r Subregion Coverage Total, warning = FALSE, echo = FALSE}

#Table of countries covered by subregion
kable(subregions[subregions$Year==2016,c("Region","Subregion","Countries","Pop","Covered","Pop_Covered","Per_Covered")], 
      caption = "Countries Covered in Estimated Trend",
      col.names = c("Region","Subregion","Total Countries","Total Population","Countries Covered","Population Covered","Proportion of Population Covered"),
      format.args = list(big.mark = ","),
      digits = 3,
      row.names = FALSE)

```

## Region Aggregates {.tabset}

```{r Region Rates Total, warning = FALSE, echo = FALSE}

#Homicide Rate by Region
ggplot(regions, aes(y = Rate_Est, x = Year, group = Region)) +
  ggtitle("Homicide Rate Trend by Region - Estimated Data") +
  ylab("Homicide Rate") +
  xlab("Year") +
  geom_line(aes(colour = Region, size = Region)) +
  geom_point(aes(colour = Region), size = 1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  ptheme

#Table of Homicide Rate by Region
wide_regions <- spread(regions[,c("Region","Year","Rate_Est")], key = "Year", value = "Rate_Est")

kable(wide_regions, caption = "Estimated Rate by Region and Year",  digits = 2)

```


## Subregion Aggregates {.tabset}

```{r Subregion Rates Total, warning = FALSE, echo = FALSE, results='asis'}

#Homicide Rate by Subregion (within each region)
for (i in unique(subregions$Region)) {
  cat("### ", i, "\n")
  a <- 
    ggplot(subregions[subregions$Region==i,], aes(y = Rate_Est, x = Year, colour = Subregion)) +
    ggtitle(paste(i,"- Homicide Rate Trend by Subregion")) +
    ylab("Homicide Rate") +
    xlab("Year") +
    geom_line(size = 1) +
    geom_point(size = 1.5) +
    geom_line(data = regions[regions$Region==i,], size = 1, color = "Black") +
    geom_point(data = regions[regions$Region==i,], size = 1.5, color = "Black") +
    ptheme
  
  print(a)
  cat("\n","\n")
}

#Homicide rate by subregion data table
cat("### Data Table", "\n")

wide_subregions <- spread(subregions[,c("Region","Subregion","Year","Rate_Est")], key = "Year", value = "Rate_Est")

kable(wide_subregions, caption = "Estimated Rate by Subregion and Year",  digits = 2)

```

----

# Ranges of Confidence

----

**Objective:**

* Generate ranges around estimated homicide trends

**Methodological Issue: Communicate Uncertainty**

* There is no clear way to estimate error that is methodologically sound
* Some solutions lack in simplicity and parsimony (i.e. bootstrapping, assume randomness)
* Observed countries are not a random sample from all countries
* We do not have information about the error structure of our our observed data

* The goal is to communicate uncertainty about our homicide values, rather than to offer confidence intervals that are methodologically precise.

**Estimation Strategy: Generate Ranges for Countries and Years Without Data**

* For Countries with 0 years of data: Ranges were defined by their subregion's minimum and maximum homicide rate
* For Countries with 1 or more years of data: Ranges corresponded to + or - 5% of estimated rate for each missing year until a observation
* In addition, added the average difference, by region, between Criminal Justice and Public Health homicide rates to the ranges of all countries in the region
* Only for country/years with data available for both Criminal Justice and Public Health
* Criminal Justice data is currently represented by the CTS (2.4 or 1.2.1)
* Public Health data is currently represented by the WHO Mortality Database (MD_2.4N)
* Country/Years with the difference greater than 50% were considered as outliers and removed from the average. This rule excluded 181 cases out of a sample of 600.

**Description:**

* The 5% corresponds to the average global yearly change in homicide rate
* The following is a selection of ilustrative countries

## Country Estimates {.tabset}

```{r Country Estimates CI, warning = FALSE, message = FALSE, echo = FALSE, results= 'asis'}

s <- c("Afghanistan","Bahamas","Egypt","Honduras","Indonesia","Myanmar","Republic of Korea","Russian Federation","Saudi Arabia","South Sudan","Togo","United Republic of Tanzania","Zimbabwe")

for (i in s) {
  cat("### ", i, "\n")
  
  a <- 
    ggplot(subset(data,UNODC_Name==i), aes(x = Year)) +
    geom_point(aes_string(y=paste0("UpperRate")), colour="Blue", shape=21, fill="white", size=2) +
    geom_line(aes_string(y=paste0("UpperRate")), colour="Blue", linetype=2) +
    geom_point(aes_string(y=paste0("LowerRate")), colour="Blue", shape=21, fill="white", size=2) +
    geom_line(aes_string(y=paste0("LowerRate")), colour="Blue", linetype=2) +
    geom_line(aes_string(y=paste0("MiddleRate")), colour="Red") +
    geom_point(aes_string(y=paste0("MiddleRate")), colour="Red", shape=21, fill="white", size=2) +
    geom_line(aes(y=Rate_Total)) +
    geom_point(aes(y=Rate_Total), size=2) +
    ggtitle(paste(i,"-",unique(data$Subregion[data$UNODC_Name==i]))) +
    ylab("Homicide Rate") +
    xlab("Year") +
    ptheme
  print(a)
  
  cat("\n","\n")
}

```

## Region Aggregates {.tabset}

```{r Region Rates CI, warning = FALSE, echo = FALSE, results='asis'}

#Confidence ranges for all regions
cat("### All Regions", "\n")

ggplot(regions, aes(y = Rate_Est, x = Year, group = Region)) +
  ggtitle("Homicide Rate Trend by Region - Estimated Data") +
  ylab("Homicide Rate") +
  xlab("Year") +
  geom_ribbon(aes_string(ymin=paste0("LowerRate"),ymax=paste0("UpperRate")), alpha=0.14, colour = "gray", linetype=0) +
  geom_line(aes_string(y=paste0("UpperRate"), colour="Region"), linetype=2) +
  geom_line(aes_string(y=paste0("LowerRate"), colour="Region"), linetype=2) +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  ptheme

cat("\n","\n")

#Range of confidence by region
for (i in unique(regions$Region)) {
  cat("### ", i, "\n")
  
  a <-
    ggplot(regions[regions$Region==i,], aes(y = Rate_Est, x = Year, group = Region)) +
    ggtitle("Homicide Rate Trend by Region - Estimated Data") +
    ylab("Homicide Rate") +
    xlab("Year") +
    geom_ribbon(aes_string(ymin=paste0("LowerRate"),ymax=paste0("UpperRate")), alpha=0.14, colour = "gray", linetype=0) +
    geom_line(aes_string(y=paste0("LowerRate"), colour="Region"), linetype=2) +
    geom_line(aes_string(y=paste0("UpperRate"), colour="Region"), linetype=2) +
    geom_line(aes(colour=Region, size=Region)) +
    geom_point(aes(colour=Region), size = 1.5) +
    scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
    scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
    ptheme
  
    print(a)
  
  cat("\n","\n")
}

#Range of confidence data table
cat("### Data Table", "\n")

a <- spread(regions[,c("Region","Year",paste0("UpperRate"))], key = "Year", value = paste0("UpperRate"))
a$Value <- "Upper"
b <- spread(regions[,c("Region","Year","Rate_Est")], key = "Year", value = "Rate_Est")
b$Value <- "Rate"
c <- spread(regions[,c("Region","Year",paste0("LowerRate"))], key = "Year", value = paste0("LowerRate"))
c$Value <- "Lower"
d <- rbind (a,b,c)

tabRegion <- select(d[order(d$Region),], Region, Value, everything())
    
kable(tabRegion, caption = "Range Estimates by Region and Year",  digits = 2, row.names=F)

```

----

# Victims by Mechanism of Killing

----

**Objective:**

* Calculate Homicide Trends by Mechanism of Killing for the World, for each Region, and for each Subregion

**Methodological Issues**

* Missing data, the same as for the total homicide, but at a greater proportion

* In addition, the sample of countries with data by mechanism is different from the sample with data for total homicide victims
* For each aggreagation, we need to maintain the coherence between the homicide rate by mechanism, and the total homicide rate
* Therefore, estimates should be based on the ratio (i.e. percent of homicides committed by firearm), as opposed to absolute rates
* The rates can be obtained at a second moment, by applying the estimated ratio to the total estimated homicide for each aggregation (World, Region, and Subregion)
* This methodology requires that only countries with data on all mechanisms be included in the sample. Considering a country with data for one individual mechanism unjustifiably increases the relative participation of that mechanism in relation to others

* Dropped entities because of partial data on mechanism disaggregation (`r length(unique(data$UNODC_Name[(is.na(data$Hom_Fire) + is.na(data$Hom_Sharp) + is.na(data$Hom_OthM) + is.na(data$Hom_UnkM))<4 & (is.na(data$Hom_Fire) + is.na(data$Hom_Sharp) + is.na(data$Hom_OthM) + is.na(data$Hom_UnkM))>0]))`): `r unique(data$UNODC_Name[(is.na(data$Hom_Fire) + is.na(data$Hom_Sharp) + is.na(data$Hom_OthM) + is.na(data$Hom_UnkM))<4 & (is.na(data$Hom_Fire) + is.na(data$Hom_Sharp) + is.na(data$Hom_OthM) + is.na(data$Hom_UnkM))>0])`

```{r Starting Year Mechanism, include=FALSE}

#First year of the indicator
st_year <- 2005

```

## Data Availability {.tabset}

### Number of Countries

```{r Number Countries Mechanism, warning = FALSE, echo = FALSE}

#Sample by Region
ggplot(regions[!is.na(regions$Sample_Mechanism),], aes(y = Sample_Mechanism, x = Year, colour = Region)) +
  ggtitle("Number of Countries with Data by Region and Year") +
  ylab("Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_x_continuous(breaks = st_year:max(data$Year), limits = c(st_year, max(data$Year))) +
  ptheme

#Table of Countries with Data by Region
wide_regions <- spread(regions[regions$Year>=st_year, c("Region","Year","Sample_Mechanism")], key = "Year", value = "Sample_Mechanism")

kable(wide_regions, caption = "Countries with Data Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)

```

### Percent of Countries

```{r Percent Countries Mechanism, warning = FALSE, echo = FALSE}

#Sample countries by region & year
ggplot(regions[!is.na(regions$Sample_Mechanism),], aes(y = Sample_Mechanism/Countries, x = Year, colour = Region)) +
  ggtitle("Proportion of Countries with Data per Region & Year") +
  ylab("Percent of Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  scale_x_continuous(breaks = st_year:max(data$Year), limits = c(st_year, max(data$Year))) +
  ptheme

#Table of Percent of Countries Estimated by Region
regions$Per_Sample_Mechanism <- paste0(round(regions$Sample_Mechanism/regions$Countries*100,1),"%")

wide_regions <- spread(regions[regions$Year>=st_year, c("Region","Year","Per_Sample_Mechanism")], key = "Year", value = "Per_Sample_Mechanism")

kable(wide_regions, caption = "Proportion of Countries with Data per Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)
regions$Per_Sample_Mechanism <- NULL

```

### Percent of Population

```{r Population Sample Mechanism, warning = FALSE, echo = FALSE}

#Sample population by region & year
ggplot(regions[!is.na(regions$Sample_Mechanism),], aes(y = Pop_Sample_Mechanism/Pop, x = Year, colour = Region)) +
  ggtitle("Percent of Population Living in Countries with Data per Region & Year") +
  ylab("Percent of Population") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  scale_x_continuous(breaks = st_year:max(data$Year), limits = c(st_year, max(data$Year))) +
  ptheme

#Table of Percent of Population from Estimated Countries by Region & Year
regions$Per_Sample_Mechanism <- paste0(round(regions$Pop_Sample_Mechanism/regions$Pop*100,1),"%")

wide_regions <- spread(regions[regions$Year>=st_year, c("Region","Year","Per_Sample_Mechanism")], key = "Year", value = "Per_Sample_Mechanism")

kable(wide_regions, caption = "Proportion of Population from Countries with Data per Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)
regions$Per_Sample_Mechanism <- NULL

```

## Country Estimates {.tabset}

**Estimation Strategy: Moving Average:**

**Description:**

* An adaptation from the same strategy as used for the total number of victims
* (1) For each country, the **ratio** (percent participation of each mechanism in relation to all other mechanism) of missing years is estimated using a Exponentially Weighted Moving average (k=100)
* The impact of each year on the average is exponentially weighted by the time-difference between that year and the estimate
* Excluding data for WHO Estimates

* (2) Estimated ratios are then applied to the total homicide count to calculate counts and rates by country
* (3) Estimated counts are summed to the level of the aggregation (World, Regions, or Subregions)
* (4) And then adjusted to match the total estimated homicide of the same aggregation

```{r Country Estimates Mechanism, warning = FALSE, message = FALSE, echo = FALSE, results= 'asis'}

#Line plot for a selection of countries
s <- c("Bahamas","Belgium","Bosnia and Herzegovina","Brazil","Colombia","Egypt","Honduras","Republic of Korea","United Republic of Tanzania","United States of America","Venezuela (Bolivarian Republic of)")

#Gather
  #Observed Ratios
pcountries1 <- data[, c("UNODC_Name","Year","Ratio_Fire","Ratio_Sharp","Ratio_OthM","Ratio_UnkM")]
pcountries1 <- gather(pcountries1, key = "Type", value = "Ratio", -UNODC_Name, - Year)
pcountries1$Type[pcountries1$Type=="Ratio_Fire"] <- "Firearm Ratio"
pcountries1$Type[pcountries1$Type=="Ratio_Sharp"] <- "Sharp Ratio"
pcountries1$Type[pcountries1$Type=="Ratio_OthM"] <- "Other Ratio"
pcountries1$Type[pcountries1$Type=="Ratio_UnkM"] <- "Unknown Ratio"

  #Estimated Ratios
pcountries2 <- data[, c("UNODC_Name","Year","Ratio_Fire_Est","Ratio_Sharp_Est","Ratio_OthM_Est","Ratio_UnkM_Est")]
pcountries2 <- gather(pcountries2, key = "Type", value = "Ratio", -UNODC_Name, - Year)
pcountries2$Type[pcountries2$Type=="Ratio_Fire_Est"] <- "Firearm Est."
pcountries2$Type[pcountries2$Type=="Ratio_Sharp_Est"] <- "Sharp Est."
pcountries2$Type[pcountries2$Type=="Ratio_OthM_Est"] <- "Other Est."
pcountries2$Type[pcountries2$Type=="Ratio_UnkM_Est"] <- "Unknown Est."

for (i in s) {
  cat("### ", i, "\n")
  a <- 
    ggplot(subset(pcountries1, UNODC_Name==i), aes(x = Year, y = Ratio, group = Type, colour = Type)) +
    geom_line(data = subset(pcountries2, UNODC_Name==i), linetype = 2) +
    geom_point(data = subset(pcountries2, UNODC_Name==i), shape=21, fill="white", size=1.8) +
    geom_point() +
    geom_line(size = 1) +
    scale_colour_manual(breaks=c("Firearm Ratio","Sharp Ratio","Other Ratio","Unknown Ratio"),
                        values = c("Firearm Ratio"="#a52a2a", "Firearm Est."="#a52a2a", 
                                   "Sharp Ratio"="#567a00", "Sharp Est."="#567a00",
                                   "Other Ratio"="#5f689d", "Other Est."="#5f689d",
                                   "Unknown Ratio"="#db8528", "Unknown Est."="#db8528")) +
    scale_x_continuous(breaks = st_year:max(data$Year), limits = c(st_year, max(data$Year))) +
    scale_y_continuous(labels = percent, limits = c(0,1)) +
    ggtitle(paste(i)) +
    xlab("Year") +
    ptheme
  
  print(a)
  cat("\n","\n")
}

#Remove obsolete objects
rm(pcountries1, pcountries2)

```

## Estimate's Coverage {.tabset}

### Region Coverage

```{r Region Coverage Mechanism, warning = FALSE, message = FALSE, echo = FALSE, results= 'asis'}

#Table of Countries Covered by Region
kable(regions[regions$Year==2016,c("Region","Countries","Pop","Covered_Mechanism","Pop_Covered_Mechanism","Per_Covered_Mechanism")], 
      caption = "Countries Covered in Estimated Trend",
      col.names = c("Region","Total Countries","Total Population","Countries Covered","Population Covered","Proportion of Population Covered"),
      format.args = list(big.mark = ","),
      digits = 3,
      row.names = FALSE)

```

### Coverage Plot

```{r Coverage Plot Mechanism, warning = FALSE, echo = FALSE}

#Sample by Region
ggplot(regions, aes(y = Covered_Mechanism, x = Year, group = Region)) +
  ggtitle("Number of Countries Covered by Region & Year") +
  ylab("Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_x_continuous(breaks = st_year:max(data$Year), limits = c(st_year, max(data$Year))) +
  ptheme

```

### Subregion Coverage

```{r Subregion Coverage Mechanism, warning = FALSE, echo = FALSE}

#Table of countries covered by subregion
kable(subregions[subregions$Year==2016,c("Region","Subregion","Countries","Pop","Covered_Mechanism","Pop_Covered_Mechanism","Per_Covered_Mechanism")], 
      caption = "Countries Covered in Estimated Trend",
      col.names = c("Region","Subregion","Total Countries","Total Population","Countries Covered","Population Covered","Proportion of Population Covered"),
      format.args = list(big.mark = ","),
      digits = 3,
      row.names = FALSE)

```

## Region Aggregates {.tabset}

```{r Region Rates Mechanism, warning = FALSE, echo = FALSE, results='asis'}

#Gather
pregions <- regions[, c("Region","Year","Rate_Est","Rate_Fire_Est","Rate_Sharp_Est","Rate_OthM_Est","Rate_UnkM_Est")]
pregions <- gather(pregions, key = "Type", value = "Rate", -Region, - Year)
pregions$Type[pregions$Type=="Rate_Fire_Est"] <- "Firearm"
pregions$Type[pregions$Type=="Rate_Sharp_Est"] <- "Sharp Obj."
pregions$Type[pregions$Type=="Rate_OthM_Est"] <- "Other Mech."
pregions$Type[pregions$Type=="Rate_UnkM_Est"] <- "Unknown Mech."
pregions$Type[pregions$Type=="Rate_Est"] <- "Total Rate"

pregions$Type <- factor(pregions$Type, levels = c("Firearm", "Sharp Obj.", "Other Mech.", "Unknown Mech.","Total Rate"))

#Homicide Rate by Subregion (within each region)
for (i in unique(regions$Region)) {
  cat("### ", i, "\n")
  a <- 
    ggplot(subset(pregions, Region==i & Year>=st_year), aes(x = Year, y = Rate, group = Type, colour = Type)) +
      ggtitle(paste(i, "- Homicide Rate Trend by Mechanism, Estimated Data")) +
      ylab("Homicide Rate") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("Firearm"="#a52a2a", "Sharp Obj."="#567a00", "Other Mech."="#5f689d", "Unknown Mech."="#db8528", "Total Rate"="Black")) +
      scale_x_continuous(breaks = st_year:max(data$Year), limits = c(st_year, max(data$Year))) +
      ptheme
  
  print(a)
  cat("\n","\n")
}

#Table of homicide rate by region
cat("### Data Table", "\n")

wide_regions <- spread(pregions[pregions$Year>=st_year,], key = "Year", value = "Rate")

kable(wide_regions, caption = "Estimated Rate by Region and Year",  digits = 2)

#Remove Obsolte Objects
rm(pregions, wide_regions)

```

## Subregion Aggregates {.tabset}

```{r Subregion Rates Mechanism, warning = FALSE, echo = FALSE, results='asis'}

#Gather
psubregions <- subregions[,c("Region","Subregion","Year","Rate_Est","Rate_Fire_Est","Rate_Sharp_Est","Rate_OthM_Est","Rate_UnkM_Est")]
psubregions <- gather(psubregions, key = "Type", value = "Rate", -Region, -Subregion, - Year)
psubregions$Type[psubregions$Type=="Rate_Fire_Est"] <- "Firearm"
psubregions$Type[psubregions$Type=="Rate_Sharp_Est"] <- "Sharp Obj."
psubregions$Type[psubregions$Type=="Rate_OthM_Est"] <- "Other Mech."
psubregions$Type[psubregions$Type=="Rate_UnkM_Est"] <- "Unknown Mech."
psubregions$Type[psubregions$Type=="Rate_Est"] <- "Total Rate"

psubregions$Type <- factor(psubregions$Type, levels = c("Firearm", "Sharp Obj.", "Other Mech.", "Unknown Mech.","Total Rate"))

#Homicide Rate by Subregion (within each region)
for (i in unique(subregions$Subregion)) {
  cat("### ", i, "\n")
  a <- 
    ggplot(subset(psubregions, Subregion==i & Year>=st_year), aes(x = Year, y = Rate, group = Type, colour = Type)) +
      ggtitle(paste(i, "- Homicide Rate Trend by Mechanism")) +
      ylab("Homicide Rate") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("Firearm"="#a52a2a", "Sharp Obj."="#567a00", "Other Mech."="#5f689d", "Unknown Mech."="#db8528", "Total Rate"="Black")) +
      scale_x_continuous(breaks = st_year:max(data$Year), limits = c(st_year, max(data$Year))) +
      ptheme
  
  print(a)
  cat("\n","\n")
}

#Table of homicide rate by region
cat("### Data Table", "\n")

wide_subregions <- spread(psubregions[psubregions$Year>=st_year,], key = "Year", value = "Rate")

kable(wide_subregions, caption = "Estimated Rate by Subregion and Year",  digits = 2)

#Remove obsolte objects
rm(wide_subregions)

```

----

# Victims by Sex

----

**Note:**

* The exact same estimation method is used for all disaggregations

```{r Starting Year Sex, include=FALSE}

#First year of the indicator
st_year <- 1990

```

## Data Availability {.tabset}

### Number of Countries

```{r Number Countries Sex, warning = FALSE, echo = FALSE}

#Sample by Region
ggplot(regions[!is.na(regions$Sample_Sex),], aes(y = Sample_Sex, x = Year, colour = Region)) +
  ggtitle("Number of Countries with Data by Region and Year") +
  ylab("Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_x_continuous(limits = c(st_year, max(data$Year))) +
  ptheme

#Table of Countries with Data by Region
wide_regions <- spread(regions[regions$Year>=st_year, c("Region","Year","Sample_Sex")], key = "Year", value = "Sample_Sex")

kable(wide_regions, caption = "Countries with Data Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)

```

### Percent of Countries

```{r Percent Countries Sex, warning = FALSE, echo = FALSE}

#Sample countries by region & year
ggplot(regions[!is.na(regions$Sample_Sex),], aes(y = Sample_Sex/Countries, x = Year, colour = Region)) +
  ggtitle("Proportion of Countries with Data per Region & Year") +
  ylab("Percent of Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  scale_x_continuous(limits = c(st_year, max(data$Year))) +
  ptheme

#Table of Percent of Countries Estimated by Region
regions$Per_Sample_Sex <- paste0(round(regions$Sample_Sex/regions$Countries*100,1),"%")

wide_regions <- spread(regions[regions$Year>=st_year, c("Region","Year","Per_Sample_Sex")], key = "Year", value = "Per_Sample_Sex")

kable(wide_regions, caption = "Proportion of Countries with Data per Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)
regions$Per_Sample_Sex <- NULL

```

### Percent of Population

```{r Population Sample Sex, warning = FALSE, echo = FALSE}

#Sample population by region & year
ggplot(regions[!is.na(regions$Sample_Sex),], aes(y = Pop_Sample_Sex/Pop, x = Year, colour = Region)) +
  ggtitle("Proportion of Population from Countries with Data per Region & Year") +
  ylab("Percent of Population") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  scale_x_continuous(limits = c(st_year, max(data$Year))) +
  ptheme

#Table of Percent of Population from Estimated Countries by Region & Year
regions$Per_Sample_Sex <- paste0(round(regions$Pop_Sample_Sex/regions$Pop*100,1),"%")

wide_regions <- spread(regions[regions$Year>=st_year, c("Region","Year","Per_Sample_Sex")], key = "Year", value = "Per_Sample_Sex")

kable(wide_regions, caption = "Proportion of Population from Countries with Data per Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)
regions$Per_Sample_Sex <- NULL

```

## Country Estimates {.tabset}

```{r Country Estimates Sex, warning = FALSE, message = FALSE, echo = FALSE, results= 'asis'}

#Line plot for a selection of countries
s <- c("Bahamas","Belgium","Bosnia and Herzegovina","Brazil","Colombia","Egypt","Holy See","Honduras","Republic of Korea","United Republic of Tanzania","United States of America","Venezuela (Bolivarian Republic of)")

#Gather
  #Ratios
pcountries1 <- data[, c("UNODC_Name","Year","RatioM","RatioF","RatioM_Est","RatioF_Est")]
pcountries1 <- gather(pcountries1, key = "Indicator", value = "Sample", -UNODC_Name, -Year)

pcountries1$Type[pcountries1$Indicator=="RatioM" | pcountries1$Indicator=="RatioF"] <- "Observed"
pcountries1$Type[pcountries1$Indicator=="RatioM_Est" | pcountries1$Indicator=="RatioF_Est"] <- "Estimated"

pcountries1$Indicator[pcountries1$Indicator=="RatioM"] <- "Male Ratio"
pcountries1$Indicator[pcountries1$Indicator=="RatioF"] <- "Female Ratio"

pcountries1$Indicator[pcountries1$Indicator=="RatioM_Est"] <- "Male Ratio"
pcountries1$Indicator[pcountries1$Indicator=="RatioF_Est"] <- "Female Ratio"

pcountries1$Indicator <- factor(pcountries1$Indicator, levels = c("Male Ratio", "Female Ratio"))
pcountries1$Type <- factor(pcountries1$Type, levels = c("Observed", "Estimated"))

pcountries1 <- pcountries1[order(pcountries1$Type, decreasing = T),]

  #Rates
pcountries2 <- data[, c("UNODC_Name","Year","RateM","RateF","Rate_Total","RateM_Est","RateF_Est","Rate_Est")]
pcountries2 <- gather(pcountries2, key = "Indicator", value = "Sample", -UNODC_Name, -Year)

pcountries2$Type[pcountries2$Indicator=="RateM" | pcountries2$Indicator=="RateF" | pcountries2$Indicator=="Rate_Total"] <- "Observed"
pcountries2$Type[pcountries2$Indicator=="RateM_Est" | pcountries2$Indicator=="RateF_Est" | pcountries2$Indicator=="Rate_Est"] <- "Estimated"

pcountries2$Indicator[pcountries2$Indicator=="Rate_Total"] <- "Total Rate"
pcountries2$Indicator[pcountries2$Indicator=="RateM"] <- "Male Rate"
pcountries2$Indicator[pcountries2$Indicator=="RateF"] <- "Female Rate"

pcountries2$Indicator[pcountries2$Indicator=="Rate_Est"] <- "Total Rate"
pcountries2$Indicator[pcountries2$Indicator=="RateM_Est"] <- "Male Rate"
pcountries2$Indicator[pcountries2$Indicator=="RateF_Est"] <- "Female Rate"

pcountries2$Indicator <- factor(pcountries2$Indicator, levels = c("Total Rate", "Male Rate", "Female Rate"))
pcountries2$Type <- factor(pcountries2$Type, levels = c("Observed", "Estimated"))

pcountries2 <- pcountries2[order(pcountries2$Type, decreasing=T),]

for (i in s) {
  cat("### ", i, "\n")
  a <- 
    ggplot(subset(pcountries1, UNODC_Name==i), aes(y = Sample, x = Year, colour = Indicator, linetype = Type, shape = Type, fill = Type)) +
    ggtitle(paste(i,"- Ratio of Victims by Sex")) +
    ylab("Ratio") +
    xlab("Year") +
    geom_line(size=1.02) +
    geom_point(size=2) +
    scale_colour_manual(values = c("Male Ratio"="#a52a2a", "Female Ratio"="Black")) +
    scale_linetype_manual(values = c("Observed"=1, "Estimated"=3)) +
    scale_shape_manual(values = c("Observed"=19, "Estimated"=21)) +
    scale_fill_manual(values = c("Observed"="Black", "Estimated"="White")) +
    scale_x_continuous(limits = c(st_year, max(data$Year))) +
    scale_y_continuous(labels = percent, limits = c(0,1)) +
    ptheme
  print (a)
  
  a <- 
    ggplot(subset(pcountries2, UNODC_Name==i), aes(y = Sample, x = Year, colour = Indicator, linetype = Type, shape = Type, fill = Type)) +
    ggtitle(paste(i,"- Rate by Sex")) +
    ylab("Ratio") +
    xlab("Year") +
    geom_line(size=1.02) +
    geom_point(size=2) +
    scale_colour_manual(values = c("Total Rate"="#5f689d", "Male Rate"="#a52a2a", "Female Rate"="Black")) +
    scale_linetype_manual(values = c("Observed"=1, "Estimated"=3)) +
    scale_shape_manual(values = c("Observed"=19, "Estimated"=21)) +
    scale_fill_manual(values = c("Observed"="Black", "Estimated"="White")) +
    scale_x_continuous(limits = c(st_year, max(data$Year))) +
    ptheme
  print (a)
  
  cat("\n","\n")
}

#Remove obsolete objects
rm(pcountries1, pcountries2)

```

## Estimate's Coverage {.tabset}

### Region Coverage

```{r Region Coverage Sex, warning = FALSE, message = FALSE, echo = FALSE, results= 'asis'}

#Table of Countries Covered by Region
kable(regions[regions$Year==2016,c("Region","Countries","Pop","Covered_Sex","Pop_Covered_Sex","Per_Covered_Sex")], 
      caption = "Countries Covered in Estimated Trend",
      col.names = c("Region","Total Countries","Total Population","Countries Covered","Population Covered","Proportion of Population Covered"),
      format.args = list(big.mark = ","),
      digits = 3,
      row.names = FALSE)

```

### Coverage Plot

```{r Coverage Plot Sex, warning = FALSE, echo = FALSE}

#Sample by Region
ggplot(regions, aes(y = Covered_Sex, x = Year, group = Region)) +
  ggtitle("Number of Countries Covered by Region & Year") +
  ylab("Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_x_continuous(limits = c(st_year, max(data$Year))) +
  ptheme

```

### Subregion Coverage

```{r Subregion Coverage Sex, warning = FALSE, echo = FALSE}

#Table of countries covered by subregion
a <- kable(subregions[subregions$Year==2016,c("Region","Subregion","Countries","Pop","Covered_Sex","Pop_Covered_Sex","Per_Covered_Sex")], 
      caption = "Countries Covered in Estimated Trend",
      col.names = c("Region","Subregion","Total Countries","Total Population","Countries Covered","Population Covered","Proportion of Population Covered"),
      format = "rst",
      format.args = list(big.mark = ","),
      digits = 3,
      row.names = FALSE)

```

## Region Aggregates {.tabset}

```{r Region Rates Sex, warning = FALSE, echo = FALSE, results='asis'}

#Gather
  #Ratio
pregions1 <- regions[, c("Region","Year","RatioM_Est","RatioF_Est")]
pregions1 <- gather(pregions1, key = "Type", value = "Ratio", -Region, -Year)
pregions1$Type[pregions1$Type=="RatioM_Est"] <- "Male Ratio"
pregions1$Type[pregions1$Type=="RatioF_Est"] <- "Female Ratio"

pregions1$Type <- factor(pregions1$Type, levels = c("Male Ratio", "Female Ratio"))

  #Rate
pregions2 <- regions[, c("Region","Year","Rate_Est","RateM_Est","RateF_Est")]
pregions2 <- gather(pregions2, key = "Type", value = "Rate", -Region, -Year)
pregions2$Type[pregions2$Type=="RateM_Est"] <- "Male Rate"
pregions2$Type[pregions2$Type=="RateF_Est"] <- "Female Rate"
pregions2$Type[pregions2$Type=="Rate_Est"] <- "Total Rate"

pregions2$Type <- factor(pregions2$Type, levels = c("Male Rate", "Female Rate","Total Rate"))

#Homicide Rate by Subregion (within each region)
for (i in unique(regions$Region)) {
  cat("### ", i, "\n")
  a <- 
    ggplot(subset(pregions1, Region==i & Year>=st_year), aes(x = Year, y = Ratio, group = Type, colour = Type)) +
      ggtitle(paste(i, "- Homicide Sex Ratio, Estimated Data")) +
      ylab("Ratio") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("Male Ratio"="#a52a2a", "Female Ratio"="Black")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      scale_y_continuous(labels = percent, limits = c(0,1)) +
      ptheme
  
  print(a)
  
  b <- 
    ggplot(subset(pregions2, Region==i & Year>=st_year), aes(x = Year, y = Rate, group = Type, colour = Type)) +
      ggtitle(paste(i, "- Homicide Rate Trend by Sex, Estimated Data")) +
      ylab("Rate") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("Male Rate"="#a52a2a", "Female Rate"="Black", "Total Rate"="#5f689d")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      ptheme
  
  print(b)
  cat("\n","\n")
}

#Table of homicide rate by region
cat("### Data Table", "\n")

wide_regions <- spread(pregions2[pregions2$Year>=st_year,], key = "Year", value = "Rate")

kable(wide_regions, caption = "Estimated Rate by Region and Year",  digits = 2)

#Remove Obsolte Objects
rm(pregions1, pregions2, wide_regions)

```

## Subregion Aggregates {.tabset}

```{r Subregion Rates Sex, warning = FALSE, echo = FALSE, results='asis'}

#Gather
  #Ratio
psubregions1 <- subregions[, c("Region","Subregion","Year","RatioM_Est","RatioF_Est")]
psubregions1 <- gather(psubregions1, key = "Type", value = "Ratio", -Region, -Subregion, -Year)
psubregions1$Type[psubregions1$Type=="RatioM_Est"] <- "Male Ratio"
psubregions1$Type[psubregions1$Type=="RatioF_Est"] <- "Female Ratio"

psubregions1$Type <- factor(psubregions1$Type, levels = c("Male Ratio", "Female Ratio"))

  #Rate
psubregions2 <- subregions[, c("Region","Subregion","Year","Rate_Est","RateM_Est","RateF_Est")]
psubregions2 <- gather(psubregions2, key = "Type", value = "Rate", -Region, -Subregion, -Year)
psubregions2$Type[psubregions2$Type=="RateM_Est"] <- "Male Rate"
psubregions2$Type[psubregions2$Type=="RateF_Est"] <- "Female Rate"
psubregions2$Type[psubregions2$Type=="Rate_Est"] <- "Total Rate"

psubregions2$Type <- factor(psubregions2$Type, levels = c("Male Rate", "Female Rate","Total Rate"))

#Homicide Rate by Subregion (within each region)
for (i in unique(subregions$Subregion)) {
  cat("### ", i, "\n")
  a <- 
    ggplot(subset(psubregions1, Subregion==i & Year>=st_year), aes(x = Year, y = Ratio, group = Type, colour = Type)) +
      ggtitle(paste(i, "- Homicide Sex Ratio, Estimated Data")) +
      ylab("Ratio") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("Male Ratio"="#a52a2a", "Female Ratio"="Black")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      scale_y_continuous(labels = percent, limits = c(0,1)) +
      ptheme
  
  print(a)
  
  a <- 
    ggplot(subset(psubregions2, Subregion==i & Year>=st_year), aes(x = Year, y = Rate, group = Type, colour = Type)) +
      ggtitle(paste(i, "- Homicide Rate Trend by Sex, Estimated Data")) +
      ylab("Rate") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("Male Rate"="#a52a2a", "Female Rate"="Black", "Total Rate"="#5f689d")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      ptheme
  
  print(a)
  cat("\n","\n")
}

#Table of homicide rate by region
cat("### Data Table", "\n")

wide_subregions <- spread(psubregions2[psubregions2$Year>=st_year,], key = "Year", value = "Rate")

kable(wide_subregions, caption = "Estimated Rate by Subregion and Year",  digits = 2)

#Remove obsolte objects
rm(wide_subregions)

```

----

# Victims by Age Group

----

```{r Starting Year Age, include=FALSE}

#First year of the indicator
st_year <- 2005

```

## Data Availability {.tabset}

### Number of Countries

```{r Number Countries Age, warning = FALSE, echo = FALSE}

#Sample by Region
ggplot(regions[!is.na(regions$Sample_Age),], aes(y = Sample_Age, x = Year, colour = Region)) +
  ggtitle("Number of Countries with Data by Region and Year") +
  ylab("Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_x_continuous(limits = c(st_year, max(data$Year))) +
  ptheme

#Table of Countries with Data by Region
wide_regions <- spread(regions[regions$Year>=st_year, c("Region","Year","Sample_Age")], key = "Year", value = "Sample_Age")

kable(wide_regions, caption = "Countries with Data Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)

```

### Percent of Countries

```{r Percent Countries Age, warning = FALSE, echo = FALSE}

#Sample countries by region & year
ggplot(regions[!is.na(regions$Sample_Age),], aes(y = Sample_Age/Countries, x = Year, colour = Region)) +
  ggtitle("Proportion of Countries with Data per Region & Year") +
  ylab("Percent of Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  scale_x_continuous(limits = c(st_year, max(data$Year))) +
  ptheme

#Table of Percent of Countries Estimated by Region
regions$Per_Sample_Age <- paste0(round(regions$Sample_Age/regions$Countries*100,1),"%")

wide_regions <- spread(regions[regions$Year>=st_year, c("Region","Year","Per_Sample_Age")], key = "Year", value = "Per_Sample_Age")

kable(wide_regions, caption = "Proportion of Countries with Data per Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)
regions$Per_Sample_Age <- NULL

```

### Percent of Population

```{r Population Sample Age, warning = FALSE, echo = FALSE}

#Sample population by region & year
ggplot(regions[!is.na(regions$Sample_Age),], aes(y = Pop_Sample_Age/Pop, x = Year, colour = Region)) +
  ggtitle("Proportion of Population from Countries with Data per Region & Year") +
  ylab("Percent of Population") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_y_continuous(labels = percent, limits = c(0,1)) +
  scale_x_continuous(limits = c(st_year, max(data$Year))) +
  ptheme

#Table of Percent of Population from Estimated Countries by Region & Year
regions$Per_Sample_Age <- paste0(round(regions$Pop_Sample_Age/regions$Pop*100,1),"%")

wide_regions <- spread(regions[regions$Year>=st_year, c("Region","Year","Per_Sample_Age")], key = "Year", value = "Per_Sample_Age")

kable(wide_regions, caption = "Proportion of Population from Countries with Data per Region & Year", digits = 2)

#Remove obsolte objects
rm(wide_regions)
regions$Per_Sample_Age <- NULL

```

## Country Estimates {.tabset}

```{r Country Estimates Age, warning = FALSE, message = FALSE, echo = FALSE, results= 'asis'}

#Line plot for a selection of countries
s <- c("Bahamas","Brazil","Colombia","Egypt","Honduras","United States of America","Venezuela (Bolivarian Republic of)")

#Gather
  #Ratios
pcountries1 <- data[, c("UNODC_Name","Year","RatioM_0_14","RatioM_15_29","RatioM_30_44","RatioM_45_59","RatioM_60_","RatioF_0_14","RatioF_15_29","RatioF_30_44","RatioF_45_59","RatioF_60_","RatioM_0_14_Est","RatioM_15_29_Est","RatioM_30_44_Est","RatioM_45_59_Est","RatioM_60_Est","RatioF_0_14_Est","RatioF_15_29_Est","RatioF_30_44_Est","RatioF_45_59_Est","RatioF_60_Est")]

pcountries1 <- gather(pcountries1, key = "Indicator", value = "Sample", -UNODC_Name, -Year)

pcountries1$Type[pcountries1$Indicator=="RatioM_0_14" | pcountries1$Indicator=="RatioM_15_29" | pcountries1$Indicator=="RatioM_30_44" | pcountries1$Indicator=="RatioM_45_59" | pcountries1$Indicator=="RatioM_60_" | pcountries1$Indicator=="RatioF_0_14" | pcountries1$Indicator=="RatioF_15_29" | pcountries1$Indicator=="RatioF_30_44" | pcountries1$Indicator=="RatioF_45_59" | pcountries1$Indicator=="RatioF_60_"] <- "Observed"

pcountries1$Type[pcountries1$Indicator=="RatioM_0_14_Est" | pcountries1$Indicator=="RatioM_15_29_Est" | pcountries1$Indicator=="RatioM_30_44_Est" | pcountries1$Indicator=="RatioM_45_59_Est" | pcountries1$Indicator=="RatioM_60_Est" | pcountries1$Indicator=="RatioF_0_14_Est" | pcountries1$Indicator=="RatioF_15_29_Est" | pcountries1$Indicator=="RatioF_30_44_Est" | pcountries1$Indicator=="RatioF_45_59_Est" | pcountries1$Indicator=="RatioF_60_Est"] <- "Estimated"

pcountries1$Sex[pcountries1$Indicator=="RatioM_0_14" | pcountries1$Indicator=="RatioM_15_29" | pcountries1$Indicator=="RatioM_30_44" | pcountries1$Indicator=="RatioM_45_59" | pcountries1$Indicator=="RatioM_60_" | pcountries1$Indicator=="RatioM_0_14_Est" | pcountries1$Indicator=="RatioM_15_29_Est" | pcountries1$Indicator=="RatioM_30_44_Est" | pcountries1$Indicator=="RatioM_45_59_Est" | pcountries1$Indicator=="RatioM_60_Est"] <- "Male"

pcountries1$Sex[pcountries1$Indicator=="RatioF_0_14" | pcountries1$Indicator=="RatioF_15_29" | pcountries1$Indicator=="RatioF_30_44" | pcountries1$Indicator=="RatioF_45_59" | pcountries1$Indicator=="RatioF_60_" | pcountries1$Indicator=="RatioF_0_14_Est" | pcountries1$Indicator=="RatioF_15_29_Est" | pcountries1$Indicator=="RatioF_30_44_Est" | pcountries1$Indicator=="RatioF_45_59_Est" | pcountries1$Indicator=="RatioF_60_Est"] <- "Female"

pcountries1$Indicator[pcountries1$Indicator=="RatioM_0_14" | pcountries1$Indicator=="RatioM_0_14_Est" | pcountries1$Indicator=="RatioF_0_14" | pcountries1$Indicator=="RatioF_0_14_Est"] <- "0 to 14"

pcountries1$Indicator[pcountries1$Indicator=="RatioM_15_29" | pcountries1$Indicator=="RatioM_15_29_Est" | pcountries1$Indicator=="RatioF_15_29" | pcountries1$Indicator=="RatioF_15_29_Est"] <- "15 to 29"

pcountries1$Indicator[pcountries1$Indicator=="RatioM_30_44" | pcountries1$Indicator=="RatioM_30_44_Est" | pcountries1$Indicator=="RatioF_30_44" | pcountries1$Indicator=="RatioF_30_44_Est"] <- "30 to 44"

pcountries1$Indicator[pcountries1$Indicator=="RatioM_45_59" | pcountries1$Indicator=="RatioM_45_59_Est" | pcountries1$Indicator=="RatioF_45_59" | pcountries1$Indicator=="RatioF_45_59_Est"] <- "45 to 59"

pcountries1$Indicator[pcountries1$Indicator=="RatioM_60_" | pcountries1$Indicator=="RatioM_60_Est" | pcountries1$Indicator=="RatioF_60_" | pcountries1$Indicator=="RatioF_60_Est"] <- "60 or more"

pcountries1$Indicator <- factor(pcountries1$Indicator, levels = c("0 to 14", "15 to 29", "30 to 44", "45 to 59", "60 or more"))
pcountries1$Type <- factor(pcountries1$Type, levels = c("Observed", "Estimated"))

pcountries1 <- pcountries1[order(pcountries1$Type, decreasing = T),]

  #Rates
pcountries2 <- data[, c("UNODC_Name","Year","RateM_0_14","RateM_15_29","RateM_30_44","RateM_45_59","RateM_60_","RateF_0_14","RateF_15_29","RateF_30_44","RateF_45_59","RateF_60_","RateM_0_14_Est","RateM_15_29_Est","RateM_30_44_Est","RateM_45_59_Est","RateM_60_Est","RateF_0_14_Est","RateF_15_29_Est","RateF_30_44_Est","RateF_45_59_Est","RateF_60_Est","RateM","RateM_Est","RateF","RateF_Est")]

pcountries2 <- gather(pcountries2, key = "Indicator", value = "Sample", -UNODC_Name, -Year)

pcountries2$Type[pcountries2$Indicator=="RateM_0_14" | pcountries2$Indicator=="RateM_15_29" | pcountries2$Indicator=="RateM_30_44" | pcountries2$Indicator=="RateM_45_59" | pcountries2$Indicator=="RateM_60_" | pcountries2$Indicator=="RateF_0_14" | pcountries2$Indicator=="RateF_15_29" | pcountries2$Indicator=="RateF_30_44" | pcountries2$Indicator=="RateF_45_59" | pcountries2$Indicator=="RateF_60_" | pcountries2$Indicator=="RateM" | pcountries2$Indicator=="RateF"] <- "Observed"

pcountries2$Type[pcountries2$Indicator=="RateM_0_14_Est" | pcountries2$Indicator=="RateM_15_29_Est" | pcountries2$Indicator=="RateM_30_44_Est" | pcountries2$Indicator=="RateM_45_59_Est" | pcountries2$Indicator=="RateM_60_Est" | pcountries2$Indicator=="RateF_0_14_Est" | pcountries2$Indicator=="RateF_15_29_Est" | pcountries2$Indicator=="RateF_30_44_Est" | pcountries2$Indicator=="RateF_45_59_Est" | pcountries2$Indicator=="RateF_60_Est" | pcountries2$Indicator=="RateM_Est" | pcountries2$Indicator=="RateF_Est"] <- "Estimated"

pcountries2$Sex[pcountries2$Indicator=="RateM_0_14" | pcountries2$Indicator=="RateM_15_29" | pcountries2$Indicator=="RateM_30_44" | pcountries2$Indicator=="RateM_45_59" | pcountries2$Indicator=="RateM_60_" | pcountries2$Indicator=="RateM_0_14_Est" | pcountries2$Indicator=="RateM_15_29_Est" | pcountries2$Indicator=="RateM_30_44_Est" | pcountries2$Indicator=="RateM_45_59_Est" | pcountries2$Indicator=="RateM_60_Est" | pcountries2$Indicator=="RateM" | pcountries2$Indicator=="RateM_Est"] <- "Male"

pcountries2$Sex[pcountries2$Indicator=="RateF_0_14" | pcountries2$Indicator=="RateF_15_29" | pcountries2$Indicator=="RateF_30_44" | pcountries2$Indicator=="RateF_45_59" | pcountries2$Indicator=="RateF_60_" | pcountries2$Indicator=="RateF_0_14_Est" | pcountries2$Indicator=="RateF_15_29_Est" | pcountries2$Indicator=="RateF_30_44_Est" | pcountries2$Indicator=="RateF_45_59_Est" | pcountries2$Indicator=="RateF_60_Est" | pcountries2$Indicator=="RateF" | pcountries2$Indicator=="RateF_Est"] <- "Female"

pcountries2$Indicator[pcountries2$Indicator=="RateM" | pcountries2$Indicator=="RateM_Est" | pcountries2$Indicator=="RateF" | pcountries2$Indicator=="RateF_Est"] <- "Total"

pcountries2$Indicator[pcountries2$Indicator=="RateM_0_14" | pcountries2$Indicator=="RateM_0_14_Est" | pcountries2$Indicator=="RateF_0_14" | pcountries2$Indicator=="RateF_0_14_Est"] <- "0 to 14"

pcountries2$Indicator[pcountries2$Indicator=="RateM_15_29" | pcountries2$Indicator=="RateM_15_29_Est" | pcountries2$Indicator=="RateF_15_29" | pcountries2$Indicator=="RateF_15_29_Est"] <- "15 to 29"

pcountries2$Indicator[pcountries2$Indicator=="RateM_30_44" | pcountries2$Indicator=="RateM_30_44_Est" | pcountries2$Indicator=="RateF_30_44" | pcountries2$Indicator=="RateF_30_44_Est"] <- "30 to 44"

pcountries2$Indicator[pcountries2$Indicator=="RateM_45_59" | pcountries2$Indicator=="RateM_45_59_Est" | pcountries2$Indicator=="RateF_45_59" | pcountries2$Indicator=="RateF_45_59_Est"] <- "45 to 59"

pcountries2$Indicator[pcountries2$Indicator=="RateM_60_" | pcountries2$Indicator=="RateM_60_Est" | pcountries2$Indicator=="RateF_60_" | pcountries2$Indicator=="RateF_60_Est"] <- "60 or more"

pcountries2$Indicator <- factor(pcountries2$Indicator, levels = c("Total","0 to 14", "15 to 29", "30 to 44", "45 to 59", "60 or more"))

pcountries2$Type <- factor(pcountries2$Type, levels = c("Observed", "Estimated"))

pcountries2 <- pcountries2[order(pcountries2$Type, decreasing = T),]

for (i in s) {
  cat("### ", i, "\n")
  a <- 
    ggplot(subset(pcountries1, UNODC_Name==i & Sex=="Male"), aes(y = Sample, x = Year, colour = Indicator, linetype = Type, shape = Type, fill = Type)) +
    ggtitle(paste(i,"- Age Distribution of Male Victims")) +
    ylab("Ratio") +
    xlab("Year") +
    geom_line(size=1.02) +
    geom_point(size=2) +
    scale_colour_manual(values = c("0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
    scale_linetype_manual(values = c("Observed"=1, "Estimated"=3)) +
    scale_shape_manual(values = c("Observed"=19, "Estimated"=21)) +
    scale_fill_manual(values = c("Observed"="Black", "Estimated"="White")) +
    scale_x_continuous(limits = c(st_year, max(data$Year))) +
    scale_y_continuous(labels = percent, limits = c(0,1)) +
    ptheme
  
  print (a)
  
  a <- 
    ggplot(subset(pcountries1, UNODC_Name==i & Sex=="Female"), aes(y = Sample, x = Year, colour = Indicator, linetype = Type, shape = Type, fill = Type)) +
    ggtitle(paste(i,"- Age Distribution of Female Victims")) +
    ylab("Ratio") +
    xlab("Year") +
    geom_line(size=1.02) +
    geom_point(size=2) +
    scale_colour_manual(values = c("0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
    scale_linetype_manual(values = c("Observed"=1, "Estimated"=3)) +
    scale_shape_manual(values = c("Observed"=19, "Estimated"=21)) +
    scale_fill_manual(values = c("Observed"="Black", "Estimated"="White")) +
    scale_x_continuous(limits = c(st_year, max(data$Year))) +
    scale_y_continuous(labels = percent, limits = c(0,1)) +
    ptheme
  
  print (a)

  a <- 
    ggplot(subset(pcountries2, UNODC_Name==i & Sex=="Male"), aes(y = Sample, x = Year, colour = Indicator, linetype = Type, shape = Type, fill = Type)) +
    ggtitle(paste(i,"- Male Rate by Age")) +
    ylab("Ratio") +
    xlab("Year") +
    geom_line(size=1.02) +
    geom_point(size=2) +
    scale_colour_manual(values = c("Total"="Black","0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
    scale_linetype_manual(values = c("Observed"=1, "Estimated"=3)) +
    scale_shape_manual(values = c("Observed"=19, "Estimated"=21)) +
    scale_fill_manual(values = c("Observed"="Black", "Estimated"="White")) +
    scale_x_continuous(limits = c(st_year, max(data$Year))) +
    ptheme
  
  print (a)
  
  a <- 
    ggplot(subset(pcountries2, UNODC_Name==i & Sex=="Female"), aes(y = Sample, x = Year, colour = Indicator, linetype = Type, shape = Type, fill = Type)) +
    ggtitle(paste(i,"- Female Rate by Age")) +
    ylab("Ratio") +
    xlab("Year") +
    geom_line(size=1.02) +
    geom_point(size=2) +
    scale_colour_manual(values = c("Total"="Black","0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
    scale_linetype_manual(values = c("Observed"=1, "Estimated"=3)) +
    scale_shape_manual(values = c("Observed"=19, "Estimated"=21)) +
    scale_fill_manual(values = c("Observed"="Black", "Estimated"="White")) +
    scale_x_continuous(limits = c(st_year, max(data$Year))) +
    ptheme
  
  print (a)
  
  cat("\n","\n")
}

#Remove obsolete objects
rm(pcountries1, pcountries2)

```

## Estimate's Coverage {.tabset}

### Region Coverage

```{r Region Coverage Age, warning = FALSE, message = FALSE, echo = FALSE, results= 'asis'}

#Table of Countries Covered by Region
kable(regions[regions$Year==2016,c("Region","Countries","Pop","Covered_Age","Pop_Covered_Age","Per_Covered_Age")], 
      caption = "Countries Covered in Estimated Trend",
      col.names = c("Region","Total Countries","Total Population","Countries Covered","Population Covered","Proportion of Population Covered"),
      format.args = list(big.mark = ","),
      digits = 3,
      row.names = FALSE)

```

### Coverage Plot

```{r Coverage Plot Age, warning = FALSE, echo = FALSE}

#Sample by Region
ggplot(regions, aes(y = Covered_Age, x = Year, group = Region)) +
  ggtitle("Number of Countries Covered by Region & Year") +
  ylab("Countries") +
  xlab("Year") +
  geom_line(aes(colour=Region, size=Region)) +
  geom_point(aes(colour=Region), size=1.5) +
  scale_colour_manual(values = c(Africa="#a52a2a", Americas="#567a00", Asia="#db8528", Europe="#5f689d", Oceania="#005aff", World="#212217")) +
  scale_size_manual(values = c(Africa=1, Americas=1, Asia=1, Europe=1, Oceania=1, World=1.4)) +
  scale_x_continuous(limits = c(st_year, max(data$Year))) +
  ptheme

```

### Subregion Coverage

```{r Subregion Coverage Age, warning = FALSE, echo = FALSE}

#Table of countries covered by subregion
kable(subregions[subregions$Year==2016,c("Region","Subregion","Countries","Pop","Covered_Age","Pop_Covered_Age","Per_Covered_Age")], 
      caption = "Countries Covered in Estimated Trend",
      col.names = c("Region","Subregion","Total Countries","Total Population","Countries Covered","Population Covered","Proportion of Population Covered"),
      format.args = list(big.mark = ","),
      digits = 3,
      row.names = FALSE)

```

## Region Aggregates {.tabset}

```{r Region Rates Age, warning = FALSE, echo = FALSE, results='asis'}

#Gather
  #Ratio
pregions1 <- regions[, c("Region","Year","RatioM_0_14_Est","RatioM_15_29_Est","RatioM_30_44_Est","RatioM_45_59_Est","RatioM_60_Est","RatioF_0_14_Est","RatioF_15_29_Est","RatioF_30_44_Est","RatioF_45_59_Est","RatioF_60_Est")]

pregions1 <- gather(pregions1, key = "Indicator", value = "Ratio", -Region, -Year)

pregions1$Sex[pregions1$Indicator=="RatioM_0_14_Est" | pregions1$Indicator=="RatioM_15_29_Est" | pregions1$Indicator=="RatioM_30_44_Est" | pregions1$Indicator=="RatioM_45_59_Est" | pregions1$Indicator=="RatioM_60_Est"] <- "Male"

pregions1$Sex[pregions1$Indicator=="RatioF_0_14_Est" | pregions1$Indicator=="RatioF_15_29_Est" | pregions1$Indicator=="RatioF_30_44_Est" | pregions1$Indicator=="RatioF_45_59_Est" | pregions1$Indicator=="RatioF_60_Est"] <- "Female"

pregions1$Indicator[pregions1$Indicator=="RatioM_0_14_Est" | pregions1$Indicator=="RatioF_0_14_Est"] <- "0 to 14"
pregions1$Indicator[pregions1$Indicator=="RatioM_15_29_Est" | pregions1$Indicator=="RatioF_15_29_Est"] <- "15 to 29"
pregions1$Indicator[pregions1$Indicator=="RatioM_30_44_Est" | pregions1$Indicator=="RatioF_30_44_Est"] <- "30 to 44"
pregions1$Indicator[pregions1$Indicator=="RatioM_45_59_Est" | pregions1$Indicator=="RatioF_45_59_Est"] <- "45 to 59"
pregions1$Indicator[pregions1$Indicator=="RatioM_60_Est" | pregions1$Indicator=="RatioF_60_Est"] <- "60 or more"

pregions1$Indicator <- factor(pregions1$Indicator, levels = c("0 to 14", "15 to 29", "30 to 44", "45 to 59", "60 or more"))

  #Rate
pregions2 <- regions[, c("Region","Year","RateM_0_14_Est","RateM_15_29_Est","RateM_30_44_Est","RateM_45_59_Est","RateM_60_Est","RateF_0_14_Est","RateF_15_29_Est","RateF_30_44_Est","RateF_45_59_Est","RateF_60_Est","RateM_Est","RateF_Est")]

pregions2 <- gather(pregions2, key = "Indicator", value = "Rate", -Region, -Year)

pregions2$Sex[pregions2$Indicator=="RateM_0_14_Est" | pregions2$Indicator=="RateM_15_29_Est" | pregions2$Indicator=="RateM_30_44_Est" | pregions2$Indicator=="RateM_45_59_Est" | pregions2$Indicator=="RateM_60_Est" | pregions2$Indicator=="RateM_Est"] <- "Male"

pregions2$Sex[pregions2$Indicator=="RateF_0_14_Est" | pregions2$Indicator=="RateF_15_29_Est" | pregions2$Indicator=="RateF_30_44_Est" | pregions2$Indicator=="RateF_45_59_Est" | pregions2$Indicator=="RateF_60_Est" | pregions2$Indicator=="RateF_Est"] <- "Female"

pregions2$Indicator[pregions2$Indicator=="RateM_0_14_Est" | pregions2$Indicator=="RateF_0_14_Est"] <- "0 to 14"
pregions2$Indicator[pregions2$Indicator=="RateM_15_29_Est" | pregions2$Indicator=="RateF_15_29_Est"] <- "15 to 29"
pregions2$Indicator[pregions2$Indicator=="RateM_30_44_Est" | pregions2$Indicator=="RateF_30_44_Est"] <- "30 to 44"
pregions2$Indicator[pregions2$Indicator=="RateM_45_59_Est" | pregions2$Indicator=="RateF_45_59_Est"] <- "45 to 59"
pregions2$Indicator[pregions2$Indicator=="RateM_60_Est" | pregions2$Indicator=="RateF_60_Est"] <- "60 or more"
pregions2$Indicator[pregions2$Indicator=="RateM_Est" | pregions2$Indicator=="RateF_Est"] <- "Total"

pregions2$Indicator <- factor(pregions2$Indicator, levels = c("Total","0 to 14", "15 to 29", "30 to 44", "45 to 59", "60 or more"))

#Homicide Rate by Subregion (within each region)
for (i in unique(regions$Region)) {
  cat("### ", i, "\n")
  a <- 
    ggplot(subset(pregions1, Region==i & Sex=="Male"), aes(x = Year, y = Ratio, group = Indicator, colour = Indicator)) +
      ggtitle(paste(i,"- Age Distribution of Male Victims")) +
      ylab("Ratio") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      scale_y_continuous(labels = percent, limits = c(0,1)) +
      ptheme
  
  print(a)
  
  a <- 
    ggplot(subset(pregions1, Region==i & Sex=="Female"), aes(x = Year, y = Ratio, group = Indicator, colour = Indicator)) +
      ggtitle(paste(i,"- Age Distribution of Female Victims")) +
      ylab("Ratio") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      scale_y_continuous(labels = percent, limits = c(0,1)) +
      ptheme
  
  print(a)

  a <- 
    ggplot(subset(pregions2, Region==i & Sex=="Male"), aes(x = Year, y = Rate, group = Indicator, colour = Indicator)) +
      ggtitle(paste(i,"- Male Rate by Age")) +
      ylab("Rate") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("Total"="Black", "0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      ptheme
  
  print(a)
  
  a <- 
    ggplot(subset(pregions2, Region==i & Sex=="Female"), aes(x = Year, y = Rate, group = Indicator, colour = Indicator)) +
      ggtitle(paste(i,"- Female Rate by Age")) +
      ylab("Rate") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("Total"="Black", "0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      ptheme
  
  print(a)
  cat("\n","\n")
}

#Table of homicide rate by region
cat("### Data Table", "\n")

wide_regions <- spread(pregions2[pregions2$Year>=st_year,], key = "Year", value = "Rate")

kable(wide_regions, caption = "Estimated Rate by Region and Year",  digits = 2)

#Remove Obsolte Objects
rm(wide_regions)

```

## Subregion Aggregates {.tabset}

```{r Subregion Rates Age, warning = FALSE, echo = FALSE, results='asis'}

psubregions1 <- subregions[, c("Subregion","Year","RatioM_0_14_Est","RatioM_15_29_Est","RatioM_30_44_Est","RatioM_45_59_Est","RatioM_60_Est","RatioF_0_14_Est","RatioF_15_29_Est","RatioF_30_44_Est","RatioF_45_59_Est","RatioF_60_Est")]

psubregions1 <- gather(psubregions1, key = "Indicator", value = "Ratio", -Subregion, -Year)

psubregions1$Sex[psubregions1$Indicator=="RatioM_0_14_Est" | psubregions1$Indicator=="RatioM_15_29_Est" | psubregions1$Indicator=="RatioM_30_44_Est" | psubregions1$Indicator=="RatioM_45_59_Est" | psubregions1$Indicator=="RatioM_60_Est"] <- "Male"

psubregions1$Sex[psubregions1$Indicator=="RatioF_0_14_Est" | psubregions1$Indicator=="RatioF_15_29_Est" | psubregions1$Indicator=="RatioF_30_44_Est" | psubregions1$Indicator=="RatioF_45_59_Est" | psubregions1$Indicator=="RatioF_60_Est"] <- "Female"

psubregions1$Indicator[psubregions1$Indicator=="RatioM_0_14_Est" | psubregions1$Indicator=="RatioF_0_14_Est"] <- "0 to 14"
psubregions1$Indicator[psubregions1$Indicator=="RatioM_15_29_Est" | psubregions1$Indicator=="RatioF_15_29_Est"] <- "15 to 29"
psubregions1$Indicator[psubregions1$Indicator=="RatioM_30_44_Est" | psubregions1$Indicator=="RatioF_30_44_Est"] <- "30 to 44"
psubregions1$Indicator[psubregions1$Indicator=="RatioM_45_59_Est" | psubregions1$Indicator=="RatioF_45_59_Est"] <- "45 to 59"
psubregions1$Indicator[psubregions1$Indicator=="RatioM_60_Est" | psubregions1$Indicator=="RatioF_60_Est"] <- "60 or more"

psubregions1$Indicator <- factor(psubregions1$Indicator, levels = c("0 to 14", "15 to 29", "30 to 44", "45 to 59", "60 or more"))

  #Rate
psubregions2 <- subregions[, c("Subregion","Year","RateM_0_14_Est","RateM_15_29_Est","RateM_30_44_Est","RateM_45_59_Est","RateM_60_Est","RateF_0_14_Est","RateF_15_29_Est","RateF_30_44_Est","RateF_45_59_Est","RateF_60_Est","RateM_Est","RateF_Est")]

psubregions2 <- gather(psubregions2, key = "Indicator", value = "Rate", -Subregion, -Year)

psubregions2$Sex[psubregions2$Indicator=="RateM_0_14_Est" | psubregions2$Indicator=="RateM_15_29_Est" | psubregions2$Indicator=="RateM_30_44_Est" | psubregions2$Indicator=="RateM_45_59_Est" | psubregions2$Indicator=="RateM_60_Est" | psubregions2$Indicator=="RateM_Est"] <- "Male"

psubregions2$Sex[psubregions2$Indicator=="RateF_0_14_Est" | psubregions2$Indicator=="RateF_15_29_Est" | psubregions2$Indicator=="RateF_30_44_Est" | psubregions2$Indicator=="RateF_45_59_Est" | psubregions2$Indicator=="RateF_60_Est" | psubregions2$Indicator=="RateF_Est"] <- "Female"

psubregions2$Indicator[psubregions2$Indicator=="RateM_0_14_Est" | psubregions2$Indicator=="RateF_0_14_Est"] <- "0 to 14"
psubregions2$Indicator[psubregions2$Indicator=="RateM_15_29_Est" | psubregions2$Indicator=="RateF_15_29_Est"] <- "15 to 29"
psubregions2$Indicator[psubregions2$Indicator=="RateM_30_44_Est" | psubregions2$Indicator=="RateF_30_44_Est"] <- "30 to 44"
psubregions2$Indicator[psubregions2$Indicator=="RateM_45_59_Est" | psubregions2$Indicator=="RateF_45_59_Est"] <- "45 to 59"
psubregions2$Indicator[psubregions2$Indicator=="RateM_60_Est" | psubregions2$Indicator=="RateF_60_Est"] <- "60 or more"
psubregions2$Indicator[psubregions2$Indicator=="RateM_Est" | psubregions2$Indicator=="RateF_Est"] <- "Total"

psubregions2$Indicator <- factor(psubregions2$Indicator, levels = c("Total","0 to 14", "15 to 29", "30 to 44", "45 to 59", "60 or more"))

#Homicide Rate by Subregion (within each region)
for (i in unique(subregions$Subregion)) {
  cat("### ", i, "\n")
   a <- 
    ggplot(subset(psubregions1, Subregion==i & Sex=="Male"), aes(x = Year, y = Ratio, group = Indicator, colour = Indicator)) +
      ggtitle(paste(i,"- Age Distribution of Male Victims")) +
      ylab("Ratio") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      scale_y_continuous(labels = percent, limits = c(0,1)) +
      ptheme
  
  print(a)
  
  a <- 
    ggplot(subset(psubregions1, Subregion==i & Sex=="Female"), aes(x = Year, y = Ratio, group = Indicator, colour = Indicator)) +
      ggtitle(paste(i,"- Age Distribution of Female Victims")) +
      ylab("Ratio") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      scale_y_continuous(labels = percent, limits = c(0,1)) +
      ptheme
  
  print(a)

  a <- 
    ggplot(subset(psubregions2, Subregion==i & Sex=="Male"), aes(x = Year, y = Rate, group = Indicator, colour = Indicator)) +
      ggtitle(paste(i,"- Male Rate by Age")) +
      ylab("Rate") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("Total"="Black", "0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      ptheme
  
  print(a)
  
  a <- 
    ggplot(subset(psubregions2, Subregion==i & Sex=="Female"), aes(x = Year, y = Rate, group = Indicator, colour = Indicator)) +
      ggtitle(paste(i,"- Female Rate by Age")) +
      ylab("Rate") +
      xlab("Year") +
      geom_line(size = 1) +
      geom_point(size = 1.5) +
      scale_colour_manual(values = c("Total"="Black", "0 to 14"="#a52a2a", "15 to 29"="#567a00", "30 to 44"="#db8528", "45 to 59"="#5f689d", "60 or more"="#005aff")) +
      scale_x_continuous(limits = c(st_year, max(data$Year))) +
      ptheme
  
  print(a)
  cat("\n","\n")
}

#Table of homicide rate by region
cat("### Data Table", "\n")

wide_subregions <- spread(psubregions2[psubregions2$Year>=st_year,], key = "Year", value = "Rate")

kable(wide_subregions, caption = "Estimated Rate by Subregion and Year",  digits = 2)

#Remove Obsolte Objects
rm(wide_subregions)

```
